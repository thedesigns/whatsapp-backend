generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             String             @id @default(uuid())
  email          String             @unique
  password       String
  name           String
  role           UserRole           @default(AGENT)
  avatar         String?
  status         UserStatus         @default(OFFLINE)
  isActive       Boolean            @default(true)
  emailNotifications Boolean         @default(true)
  pushNotifications  Boolean         @default(true)
  lastSeen       DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  organizationId String?
  pushToken      String?
  conversations  Conversation[]     @relation("AssignedAgent")
  notes          ConversationNote[]
  messages       Message[]          @relation("SentBy")
  organization   Organization?      @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
}

model Organization {
  id                 String         @id @default(uuid())
  name               String
  wabaId             String?
  phoneNumberId      String?
  accessToken        String?        @db.Text
  verifyToken        String?
  isActive           Boolean        @default(true)
  subscriptionPlanId String?
  subscriptionPlan   Plan?          @relation(fields: [subscriptionPlanId], references: [id])
  subscriptionStatus String?        @default("ACTIVE")
  billingCycle       String?        @default("MONTHLY") // MONTHLY, YEARLY
  subscriptionExpiry DateTime?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  apiKey             String?        @unique
  externalWebhookUrl String?        @db.Text
  externalWebhookSecret String?     @db.Text
  broadcasts         Broadcast[]
  contacts           Contact[]
  conversations      Conversation[]
  flows              Flow[]
  flowSessions       FlowSession[]
  messages           Message[]
  quickReplies       QuickReply[]
  templates          Template[]
  users              User[]
  contactGroups      ContactGroup[]
  integrations       Integration[]
  integrationEvents  IntegrationEvent[]
  scheduledNotifications ScheduledNotification[]

  @@index([subscriptionPlanId])
}

model Plan {
  id          String   @id @default(uuid())
  name        String   @unique
  price       Float    @default(0)
  yearlyPrice Float    @default(0)
  limits      String   @db.LongText // JSON string for limits (e.g., messages per month)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  organizations Organization[]
}

model Contact {
  id             String         @id @default(uuid())
  waId           String
  name           String?
  profileName    String?
  phoneNumber    String
  email          String?
  avatar         String?
  tags           String         @db.LongText
  metadata       String?        @db.LongText
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversations  Conversation[]
  flowSessions   FlowSession[]
  groups         ContactGroup[] @relation("ContactToGroup")

  @@unique([waId, organizationId])
  @@index([waId])
  @@index([organizationId])
}

model Conversation {
  id                 String             @id @default(uuid())
  status             ConversationStatus @default(OPEN)
  priority           Priority           @default(MEDIUM)
  channel            String             @default("whatsapp")
  lastMessageAt      DateTime?
  lastMessagePreview String?
  unreadCount        Int                @default(0)
  isResolved         Boolean            @default(false)
  resolvedAt         DateTime?
  tags               String             @db.LongText
  broadcastId        String?            // Link to originating broadcast
  broadcastName      String?            // Cached broadcast name for quick access
  isReply            Boolean            @default(false) // True if customer replied after broadcast
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  contactId          String
  assignedAgentId    String?
  organizationId     String
  assignedAgent      User?              @relation("AssignedAgent", fields: [assignedAgentId], references: [id])
  contact            Contact            @relation(fields: [contactId], references: [id], onDelete: Cascade)
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  broadcast          Broadcast?         @relation(fields: [broadcastId], references: [id])
  notes              ConversationNote[]
  messages           Message[]

  @@index([status])
  @@index([assignedAgentId])
  @@index([organizationId])
  @@index([contactId], map: "Conversation_contactId_fkey")
  @@index([broadcastId])
}

model Message {
  id             String        @id @default(uuid())
  waMessageId    String?       @unique
  type           MessageType   @default(TEXT)
  content        String?       @db.LongText
  caption        String?       @db.Text
  mediaUrl       String?       @db.Text
  mediaId        String?
  mediaType      String?
  mediaSize      Int?
  fileName       String?
  direction      Direction
  status         MessageStatus @default(SENT)
  isRead         Boolean       @default(false)
  metadata       String?       @db.LongText
  timestamp      DateTime      @default(now())
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  conversationId String
  senderId       String?
  organizationId String
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sender         User?         @relation("SentBy", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([organizationId])
  @@index([timestamp])
  @@index([senderId], map: "Message_senderId_fkey")
}

model Template {
  id             String           @id @default(uuid())
  name           String
  category       TemplateCategory
  language       String           @default("en")
  status         TemplateStatus   @default(PENDING)
  components     String           @db.LongText
  example        String?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([name, organizationId])
  @@index([organizationId], map: "Template_organizationId_fkey")
}

model QuickReply {
  id             String       @id @default(uuid())
  title          String
  shortcut       String
  content        String
  category       String?
  isActive       Boolean      @default(true)
  usageCount     Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([shortcut, organizationId])
  @@index([organizationId], map: "QuickReply_organizationId_fkey")
}

model ConversationNote {
  id             String       @id @default(uuid())
  content        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversationId String
  userId         String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId], map: "ConversationNote_userId_fkey")
}

model Broadcast {
  id               String               @id @default(uuid())
  name             String
  templateName     String
  templateLanguage String               @default("en")
  status           BroadcastStatus      @default(PENDING)
  totalRecipients  Int                  @default(0)
  sentCount        Int                  @default(0)
  deliveredCount   Int                  @default(0)
  readCount        Int                  @default(0)
  failedCount      Int                  @default(0)
  replyCount       Int                  @default(0) // Track total replies
  scheduledAt      DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  organizationId   String
  mediaId          String?
  mediaType        String?
  organization     Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  recipients       BroadcastRecipient[]
  conversations    Conversation[]       // Conversations that originated from this broadcast

  @@index([organizationId])
  @@index([status])
}

model BroadcastRecipient {
  id          String        @id @default(uuid())
  phoneNumber String
  waId        String?
  contactName String?
  variables   String?       @db.LongText
  status      MessageStatus @default(PENDING)
  error       String?       @db.Text
  waMessageId String?       @unique
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  broadcastId String
  broadcast   Broadcast     @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  @@index([broadcastId])
  @@index([status])
}

model Flow {
  id             String        @id @default(uuid())
  name           String
  description    String?       @db.Text
  nodes          String        @db.LongText
  edges          String        @db.LongText
  triggerKeyword String?
  isDefault      Boolean       @default(false)
  isActive       Boolean       @default(true)
  workingHours   String?       @db.LongText
  sessionTimeout Int           @default(3600)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sessions       FlowSession[]

  @@index([organizationId])
}

model FlowSession {
  id              String            @id @default(uuid())
  currentNodeId   String?
  variables       String            @db.LongText
  status          FlowSessionStatus @default(ACTIVE)
  lastInteraction DateTime          @default(now())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  flowId          String
  contactId       String
  organizationId  String
  contact         Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)
  flow            Flow              @relation(fields: [flowId], references: [id], onDelete: Cascade)
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([contactId, organizationId])
  @@index([flowId])
  @@index([organizationId])
}

model ContactGroup {
  id             String       @id @default(uuid())
  name           String
  description    String?      @db.Text
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts       Contact[]    @relation("ContactToGroup")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([name, organizationId])
  @@index([organizationId])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  AGENT
  SUPERVISOR
}

enum UserStatus {
  ONLINE
  OFFLINE
  BUSY
  AWAY
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  LOCATION
  CONTACTS
  STICKER
  INTERACTIVE
  BUTTON
  LIST
  TEMPLATE
  REACTION
  ORDER
  CATALOGUE
  FLOW
  SYSTEM
  UNKNOWN
}

enum Direction {
  INCOMING
  OUTGOING
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum TemplateCategory {
  MARKETING
  UTILITY
  AUTHENTICATION
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BroadcastStatus {
  PENDING
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum FlowSessionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

model Integration {
  id             String          @id @default(uuid())
  type           IntegrationType
  name           String
  config         String          @db.LongText // JSON configuration
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
}

model IntegrationEvent {
  id             String       @id @default(uuid())
  integrationId  String?
  source         String       // shopify, woocommerce, zoho, etc.
  event          String       // orders/create, checkout/create, etc.
  payload        String       @db.LongText
  processed      Boolean      @default(false)
  error          String?      @db.Text
  createdAt      DateTime     @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([source])
  @@index([createdAt])
}

model ScheduledNotification {
  id             String           @id @default(uuid())
  type           NotificationType
  status         String           @default("PENDING") // PENDING, SENT, CANCELLED, FAILED
  recipient      String           // Phone number
  payload        String           @db.LongText // Data for template variables
  templateName   String
  scheduledAt    DateTime
  sentAt         DateTime?
  cancelledAt    DateTime?
  error          String?          @db.Text
  externalId     String?          // e.g. Shopify Checkout ID to allow cancellation
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([scheduledAt])
  @@index([externalId])
}

enum IntegrationType {
  SHOPIFY
  WOOCOMMERCE
  ZOHO
  TALLY
  CUSTOM
}

enum NotificationType {
  ABANDONED_CART
  ORDER_FOLLOWUP
  CUSTOM
}
